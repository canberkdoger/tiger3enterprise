WITH VardiyaZamanlari AS (
    SELECT 
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
        END as VardiyaBaslangic,
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(DAY, 1, DATEADD(HOUR, 3, GETUTCDATE())) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
        END as VardiyaBitis
)
SELECT 
    h.ISTASYONREF,
    h.DISPLINEREF,
    MAX(h.ZAMAN) as SON_ZAMAN,
    SUM(h.MIKTAR) as TOPLAM_MIKTAR
FROM dbo.DT_URTVT_DISPLINE_HURDA h
CROSS JOIN VardiyaZamanlari v
WHERE h.HURDAREF = '6'
AND h.ZAMAN >= v.VardiyaBaslangic
AND h.ZAMAN < v.VardiyaBitis
GROUP BY 
    h.ISTASYONREF,
    h.DISPLINEREF
ORDER BY 
    h.ISTASYONREF,
    SON_ZAMAN DESC;