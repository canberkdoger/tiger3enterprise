WITH RankedStations AS 
(
    SELECT 
        DT.LOGICALREF AS DT_DISPLINEREF, 
        DT.LOGO_PRODORDREF, 
        DT.LOGO_DISPLINEREF, 
        ITEMS.CODE AS URUN_KODU, 
        ITEMS.NAME AS URUN_ADI, 
        SPEC.DEFINITION_ AS KALIP_ADI, 
        PROD.PLNAMOUNT AS PLANLANAN_MIKTAR, 
        PROD.ACTAMOUNT AS GERCEKLESEN_MIKTAR, 
        LG_DISP.RUNBATCH AS REFERANS_GOZ_SAYISI, 
        CAST(
            CAST(DATEDIFF(SECOND, '00:00:00', dbo.LG_INTTOTIME(LG_DISP.RUNTIME)) AS VARCHAR) 
            + '.' + 
            RIGHT('000' + CAST(DATEDIFF(MILLISECOND, '00:00:00', dbo.LG_INTTOTIME(LG_DISP.RUNTIME)) % 1000 AS VARCHAR), 3) 
        AS VARCHAR) AS REFERANS_CEVRIM, 
        DT.ISTASYON, 
        DT.LAST_COUNTER AS SAYAC, 
        DT.FIRST_COMM AS BASLANGIC_ZAMANI, 
        DT.TOPLAM_HURDA AS HURDA, 
        DT.STATUS,
        MB.[Palet İçi Adet] AS PALET_ICI_MIKTAR,
        ROW_NUMBER() OVER (
            PARTITION BY DT.ISTASYON 
            ORDER BY 
                CASE DT.STATUS 
                    WHEN 1 THEN 1
                    WHEN 2 THEN 2
                    WHEN 0 THEN 3
                    ELSE 4
                END
        ) as RN
    FROM dbo.DT_URTVT_DISPLINE AS DT WITH (NOLOCK)
    LEFT JOIN dbo.LG_125_DISPLINE AS LG_DISP WITH (NOLOCK)
        ON DT.LOGO_DISPLINEREF = LG_DISP.LOGICALREF 
    LEFT JOIN dbo.LG_125_ITEMS AS ITEMS WITH (NOLOCK)
        ON LG_DISP.ITEMREF = ITEMS.LOGICALREF 
    LEFT JOIN dbo.LG_125_SPECODES AS SPEC WITH (NOLOCK)
        ON ITEMS.SPECODE3 = SPEC.SPECODE 
    LEFT JOIN dbo.LG_125_PRODORD AS PROD WITH (NOLOCK)
        ON DT.LOGO_PRODORDREF = PROD.LOGICALREF
    LEFT JOIN dbo.FCD_MALZEMEBIRIMLER AS MB WITH (NOLOCK)
        ON ITEMS.CODE = MB.[Ürün Kodu]
    WHERE DT.STATUS NOT IN (3, 4)
)
SELECT 
    DT_DISPLINEREF,  
    LOGO_PRODORDREF, 
    LOGO_DISPLINEREF, 
    URUN_KODU, 
    URUN_ADI, 
    KALIP_ADI, 
    PLANLANAN_MIKTAR, 
    GERCEKLESEN_MIKTAR, 
    REFERANS_GOZ_SAYISI, 
    REFERANS_CEVRIM, 
    ISTASYON, 
    SAYAC, 
    BASLANGIC_ZAMANI, 
    HURDA, 
    STATUS,
    PALET_ICI_MIKTAR
FROM RankedStations
WHERE RN = 1