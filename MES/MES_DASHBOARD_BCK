SELECT        MES_DB_MAKINELER.MAKINEREF ISTASYON, MES_DB_MAKINELER.MAKINE_KODU, MES_DB_MAKINELER.MAKINE_ADI, CASE WHEN MES_DB_MAKINELER.MAKINE_KODU IN ('113', '114') 
                         THEN 'ŞEKER' WHEN MES_DB_MAKINELER.MAKINE_KODU IN ('115', '116') THEN 'OYUNCAK' WHEN MES_DB_MAKINELER.MAKINE_ADI LIKE '%STICKER%' THEN 'STICKER' ELSE 'ENJEKSİYON' END AS GRUP, 
                         CASE WHEN MES_DB_URETIMEMIRLERI.STATUS = 0 THEN 'ÇALIŞMIYOR - PLAN VAR' WHEN MES_DB_URETIMEMIRLERI.STATUS = 1 THEN 'ÇALIŞIYOR' WHEN MES_DB_URETIMEMIRLERI.STATUS = 2 THEN 'DURUŞ' WHEN MES_DB_URETIMEMIRLERI.STATUS
                          IS NULL THEN 'BOŞTA - PLAN YOK' END AS DURUM, 
                         CASE WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) 
                         <= 0 THEN 'MİKTAR AŞILDI' WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) 
                         <= MES_DB_URETIMEMIRLERI.PALET_ICI_MIKTAR THEN 'SON PALET' ELSE NULL END AS DURUM2, /* En son duruşun nedenini getir*/ CASE WHEN MES_DB_URETIMEMIRLERI.STATUS = 2 THEN
                             (SELECT        TOP 1 TANIMI
                               FROM            MES_DB_DURUSLAR WITH (NOLOCK)
                               WHERE        ISTASYON = MES_DB_MAKINELER.MAKINEREF AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF) ELSE NULL END AS DURUS_NEDENI, MES_DB_URETIMEMIRLERI.URUN_KODU, 
                         MES_DB_URETIMEMIRLERI.URUN_ADI, MES_DB_URETIMEMIRLERI.KALIP_ADI, MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR, MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR, 
                         MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR AS SAYAC_MIKTAR, 
                         MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR) AS KALAN_MIKTAR, 
                         MES_DB_URETIMEMIRLERI.REFERANS_GOZ_SAYISI, MES_DB_CEVRIM.MIKTAR AS GERCEK_GOZ_SAYISI, MES_DB_URETIMEMIRLERI.REFERANS_CEVRIM, MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, 
                         MES_DB_URETIMEMIRLERI.BASLANGIC_ZAMANI, 
                         CASE WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) <= 0 THEN NULL 
                         ELSE DATEADD(SECOND, CEILING((MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) 
                         * CAST(SUBSTRING(MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, 1, CHARINDEX('.', MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI) - 1) AS FLOAT) / MES_DB_CEVRIM.MIKTAR), CAST(GETUTCDATE() 
                         AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) END AS BITIS_ZAMANI, MES_DB_URETIMEMIRLERI.HURDA, 
                         CASE WHEN MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR > 0 THEN CAST((CAST(MES_DB_URETIMEMIRLERI.HURDA AS FLOAT) * 100.0) 
                         / (MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR + (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) AS DECIMAL(10, 2)) ELSE 0 END AS FIRE_ORANI,
                             /* O iş emrindeki toplam duruş süresi*/ (SELECT        ISNULL(SUM(SURE_DAKIKA), 0)
                                                                                                                     FROM            MES_DB_DURUSLAR WITH (NOLOCK)
                                                                                                                     WHERE        ISTASYON = MES_DB_MAKINELER.MAKINEREF AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF) AS DURUS_TOPLAM,
                             /* O vardiyada gerçekleşen duruş süresi*/ (SELECT        ISNULL(SUM(SURE_DAKIKA), 0)
                                                                                                                           FROM            MES_DB_DURUSLAR WITH (NOLOCK)
                                                                                                                           WHERE        ISTASYON = MES_DB_MAKINELER.MAKINEREF AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF AND BASLANGIC >= DATEADD(MINUTE, 
                                                                                                                                                     CASE WHEN (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) >= 0 AND DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 8) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 8 AND DATEPART(MINUTE, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 30) THEN - 450 /* 00:30 (current day)*/ WHEN (DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 8 AND DATEPART(MINUTE, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) >= 30) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) > 8 AND DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 16) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 16 AND DATEPART(MINUTE, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 30) THEN 30 /* 08:30*/ ELSE 510 /* 16:30*/ END, CAST(CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATE) AS DATETIME)) AND BASLANGIC < DATEADD(MINUTE, CASE WHEN (DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) >= 0 AND DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 8) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 8 AND DATEPART(MINUTE, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 30) THEN 30 /* 08:30*/ WHEN (DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 8 AND DATEPART(MINUTE, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) >= 30) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) > 8 AND DATEPART(HOUR, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 16) OR
                                                                                                                                                     (DATEPART(HOUR, CAST(GETUTCDATE() AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) = 16 AND DATEPART(MINUTE, CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATETIME)) < 30) THEN 510 /* 16:30*/ ELSE 990 /* 00:30 (next day)*/ END, CAST(CAST(GETUTCDATE() 
                                                                                                                                                     AT TIME ZONE 'Turkey Standard Time' AS DATE) AS DATETIME))) AS DURUS_VARDIYA
FROM            MES_DB_MAKINELER WITH (NOLOCK) LEFT OUTER JOIN
                         MES_DB_URETIMEMIRLERI WITH (NOLOCK) ON MES_DB_MAKINELER.MAKINEREF = MES_DB_URETIMEMIRLERI.ISTASYON LEFT OUTER JOIN
                         MES_DB_CEVRIM WITH (NOLOCK) ON MES_DB_MAKINELER.MAKINEREF = MES_DB_CEVRIM.MAKINE_NO
WHERE        MES_DB_MAKINELER.MAKINE_ADI NOT IN ('FASON', 'MONTAJ');