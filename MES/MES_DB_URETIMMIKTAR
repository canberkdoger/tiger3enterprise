WITH VardiyaZamanlari AS (
    SELECT 
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
        END as VardiyaBaslangic,
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(DAY, 1, DATEADD(HOUR, 3, GETUTCDATE())) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
        END as VardiyaBitis
),
IstasyonVerileri AS (
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '1' as ISTASYON
    FROM DT_URTVT_DISPLINE_1 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '2' as ISTASYON
    FROM DT_URTVT_DISPLINE_2 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '3' as ISTASYON
    FROM DT_URTVT_DISPLINE_3 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '4' as ISTASYON
    FROM DT_URTVT_DISPLINE_4 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '5' as ISTASYON
    FROM DT_URTVT_DISPLINE_5 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '6' as ISTASYON
    FROM DT_URTVT_DISPLINE_6 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '7' as ISTASYON
    FROM DT_URTVT_DISPLINE_7 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '8' as ISTASYON
    FROM DT_URTVT_DISPLINE_8 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '9' as ISTASYON
    FROM DT_URTVT_DISPLINE_9 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '10' as ISTASYON
    FROM DT_URTVT_DISPLINE_10 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '11' as ISTASYON
    FROM DT_URTVT_DISPLINE_11 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '12' as ISTASYON
    FROM DT_URTVT_DISPLINE_12 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '13' as ISTASYON
    FROM DT_URTVT_DISPLINE_13 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '14' as ISTASYON
    FROM DT_URTVT_DISPLINE_14 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '15' as ISTASYON
    FROM DT_URTVT_DISPLINE_15 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '16' as ISTASYON
    FROM DT_URTVT_DISPLINE_16 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '17' as ISTASYON
    FROM DT_URTVT_DISPLINE_17 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '18' as ISTASYON
    FROM DT_URTVT_DISPLINE_18 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '19' as ISTASYON
    FROM DT_URTVT_DISPLINE_19 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '20' as ISTASYON
    FROM DT_URTVT_DISPLINE_20 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '21' as ISTASYON
    FROM DT_URTVT_DISPLINE_21 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '22' as ISTASYON
    FROM DT_URTVT_DISPLINE_22 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '23' as ISTASYON
    FROM DT_URTVT_DISPLINE_23 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '24' as ISTASYON
    FROM DT_URTVT_DISPLINE_24 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '25' as ISTASYON
    FROM DT_URTVT_DISPLINE_25 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '26' as ISTASYON
    FROM DT_URTVT_DISPLINE_26 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '27' as ISTASYON
    FROM DT_URTVT_DISPLINE_27 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '28' as ISTASYON
    FROM DT_URTVT_DISPLINE_28 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '29' as ISTASYON
    FROM DT_URTVT_DISPLINE_29 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '30' as ISTASYON
    FROM DT_URTVT_DISPLINE_30 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '31' as ISTASYON
    FROM DT_URTVT_DISPLINE_31 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '32' as ISTASYON
    FROM DT_URTVT_DISPLINE_32 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '33' as ISTASYON
    FROM DT_URTVT_DISPLINE_33 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '34' as ISTASYON
    FROM DT_URTVT_DISPLINE_34 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '35' as ISTASYON
    FROM DT_URTVT_DISPLINE_35 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '36' as ISTASYON
    FROM DT_URTVT_DISPLINE_36 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '37' as ISTASYON
    FROM DT_URTVT_DISPLINE_37 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '38' as ISTASYON
    FROM DT_URTVT_DISPLINE_38 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '39' as ISTASYON
    FROM DT_URTVT_DISPLINE_39 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '40' as ISTASYON
    FROM DT_URTVT_DISPLINE_40 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '41' as ISTASYON
    FROM DT_URTVT_DISPLINE_41 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '42' as ISTASYON
    FROM DT_URTVT_DISPLINE_42 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '43' as ISTASYON
    FROM DT_URTVT_DISPLINE_43 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '44' as ISTASYON
    FROM DT_URTVT_DISPLINE_44 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '45' as ISTASYON
    FROM DT_URTVT_DISPLINE_45 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '46' as ISTASYON
    FROM DT_URTVT_DISPLINE_46 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '47' as ISTASYON
    FROM DT_URTVT_DISPLINE_47 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '48' as ISTASYON
    FROM DT_URTVT_DISPLINE_48 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '49' as ISTASYON
    FROM DT_URTVT_DISPLINE_49 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '50' as ISTASYON
    FROM DT_URTVT_DISPLINE_50 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '51' as ISTASYON
    FROM DT_URTVT_DISPLINE_51 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '52' as ISTASYON
    FROM DT_URTVT_DISPLINE_52 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
UNION ALL
SELECT 
        d.DISPLINEREF,
        d.BASLANGIC,
        d.BITIS,
        d.MIKTAR,
        d.PERSONEL_1,
        p.ADSOYAD,
        '53' as ISTASYON
    FROM DT_URTVT_DISPLINE_53 d WITH (NOLOCK)
    LEFT JOIN DT_URTVT_PERSONEL p WITH (NOLOCK) ON d.PERSONEL_1 = p.LOGICALREF
),
SiraliVeriler AS (
    SELECT 
        i.*,
        ROW_NUMBER() OVER (PARTITION BY i.ISTASYON, i.DISPLINEREF ORDER BY i.BASLANGIC DESC) as RN
    FROM IstasyonVerileri i
    CROSS JOIN VardiyaZamanlari v
    WHERE i.BITIS IS NOT NULL
    AND i.BASLANGIC >= v.VardiyaBaslangic
    AND i.BASLANGIC < v.VardiyaBitis
)
SELECT 
    s.ISTASYON,
    s.DISPLINEREF,
    SUM(s.MIKTAR) as TOPLAM_MIKTAR,
    MAX(CASE WHEN s.RN = 1 THEN ISNULL(s.ADSOYAD, 'Tanımsız') END) as SON_PERSONEL,
    MAX(CASE WHEN s.RN = 1 THEN s.BASLANGIC END) as SON_BASLANGIC
FROM SiraliVeriler s
GROUP BY s.ISTASYON, s.DISPLINEREF