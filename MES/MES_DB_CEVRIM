WITH AllMachines AS (
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '1' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_1] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '2' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_2] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '3' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_3] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '4' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_4] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '5' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_5] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '6' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_6] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '7' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_7] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '8' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_8] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '9' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_9] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '10' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_10] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '11' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_11] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '12' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_12] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '13' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_13] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '14' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_14] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '15' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_15] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '16' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_16] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '17' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_17] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '18' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_18] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '19' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_19] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '20' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_20] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '21' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_21] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '22' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_22] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '23' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_23] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '24' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_24] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '25' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_25] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '26' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_26] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '27' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_27] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '28' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_28] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '29' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_29] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '30' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_30] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '31' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_31] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '32' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_32] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '33' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_33] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '34' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_34] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '35' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_35] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '36' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_36] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '37' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_37] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '38' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_38] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '39' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_39] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '40' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_40] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '41' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_41] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '42' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_42] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '43' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_43] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '44' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_44] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '45' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_45] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '46' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_46] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '47' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_47] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '48' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_48] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '49' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_49] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '50' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_50] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '51' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_51] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '52' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_52] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '53' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_53] WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
),
RankedRecords AS (
    SELECT 
        [LOGICALREF],
        [MAKINE_NO],
        [BASLANGIC],
        [BITIS],
        [MIKTAR],
        DATEDIFF(SECOND, [BASLANGIC], [BITIS]) as CEVRIM_SURESI,
        ROW_NUMBER() OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF] DESC) as RowNum,
        LAG([LOGICALREF]) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF,
        LAG([BASLANGIC]) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC,
        LAG([BITIS]) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS,
        LAG([MIKTAR]) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR
    FROM AllMachines
)
SELECT 
    [MAKINE_NO],
    [LOGICALREF] as SON_LOGICALREF,
    CASE 
        WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BASLANGIC
        ELSE [BASLANGIC]
    END as BASLANGIC,
    CASE 
        WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BITIS
        ELSE [BITIS]
    END as BITIS,
    CAST(
        DATEDIFF(SECOND, 
            CASE 
                WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BASLANGIC
                ELSE [BASLANGIC]
            END, 
            CASE 
                WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BITIS
                ELSE [BITIS]
            END
        ) as VARCHAR
    ) + '.' + 
    RIGHT('000' + CAST(
        DATEDIFF(MILLISECOND, 
            CASE 
                WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BASLANGIC
                ELSE [BASLANGIC]
            END, 
            CASE 
                WHEN CEVRIM_SURESI > 50 THEN ONCEKI_BITIS
                ELSE [BITIS]
            END
        ) % 1000 as VARCHAR), 3) as GERCEK_CEVRIM_SURESI,
    CASE 
        WHEN CEVRIM_SURESI > 50 THEN ONCEKI_MIKTAR
        ELSE [MIKTAR]
    END as MIKTAR,
    CASE 
        WHEN CEVRIM_SURESI > 50 THEN 'Önceki Kayıt Kullanıldı'
        ELSE 'Son Kayıt Kullanıldı'
    END as KAYIT_BILGISI
FROM RankedRecords
WHERE RowNum = 1 
  AND (
    (CEVRIM_SURESI <= 50 AND [BASLANGIC] IS NOT NULL AND [BITIS] IS NOT NULL) OR
    (CEVRIM_SURESI > 50 AND ONCEKI_BASLANGIC IS NOT NULL AND ONCEKI_BITIS IS NOT NULL)
  );