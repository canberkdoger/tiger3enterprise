WITH AllMachines AS (
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '1' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_1] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '2' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_2] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '3' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_3] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '4' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_4] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '5' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_5] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '6' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_6] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '7' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_7] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '8' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_8] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '9' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_9] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '10' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_10] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '11' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_11] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '12' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_12] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '13' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_13] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '14' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_14] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '15' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_15] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '16' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_16] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '17' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_17] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '18' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_18] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '19' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_19] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '20' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_20] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '21' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_21] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '22' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_22] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '23' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_23] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '24' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_24] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '25' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_25] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '26' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_26] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '27' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_27] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '28' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_28] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '29' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_29] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '30' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_30] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '31' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_31] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '32' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_32] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '33' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_33] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '34' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_34] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '35' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_35] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '36' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_36] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '37' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_37] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '38' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_38] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '39' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_39] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '40' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_40] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '41' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_41] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '42' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_42] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '43' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_43] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '44' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_44] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '45' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_45] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '46' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_46] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '47' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_47] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '48' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_48] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '49' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_49] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '50' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_50] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '51' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_51] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '52' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_52] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
    UNION ALL
    SELECT [LOGICALREF], [BASLANGIC], [BITIS], [MIKTAR], '53' as MAKINE_NO FROM [TIGERENT_2022].[dbo].[DT_URTVT_DISPLINE_53] WITH (NOLOCK) WHERE [BITIS] IS NOT NULL AND [BASLANGIC] IS NOT NULL
),
RankedRecords AS (
    SELECT 
        [LOGICALREF],
        [MAKINE_NO],
        [BASLANGIC],
        [BITIS],
        [MIKTAR],
        CASE 
            WHEN [MIKTAR] > 100 THEN NULL  -- Miktar 100'den büyükse çevrim süresini NULL yapıyoruz
            ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS])
        END as CEVRIM_SURESI,
        ROW_NUMBER() OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF] DESC) as RowNum,
        
        -- Son 5 kayıt için LAG fonksiyonları
        LAG([LOGICALREF], 1) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF_1,
        LAG([BASLANGIC], 1) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC_1,
        LAG([BITIS], 1) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS_1,
        LAG([MIKTAR], 1) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR_1,
        LAG(CASE WHEN [MIKTAR] > 100 THEN NULL ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS]) END, 1) 
            OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_CEVRIM_1,
        
        LAG([LOGICALREF], 2) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF_2,
        LAG([BASLANGIC], 2) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC_2,
        LAG([BITIS], 2) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS_2,
        LAG([MIKTAR], 2) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR_2,
        LAG(CASE WHEN [MIKTAR] > 100 THEN NULL ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS]) END, 2) 
            OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_CEVRIM_2,
        
        LAG([LOGICALREF], 3) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF_3,
        LAG([BASLANGIC], 3) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC_3,
        LAG([BITIS], 3) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS_3,
        LAG([MIKTAR], 3) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR_3,
        LAG(CASE WHEN [MIKTAR] > 100 THEN NULL ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS]) END, 3) 
            OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_CEVRIM_3,
        
        LAG([LOGICALREF], 4) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF_4,
        LAG([BASLANGIC], 4) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC_4,
        LAG([BITIS], 4) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS_4,
        LAG([MIKTAR], 4) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR_4,
        LAG(CASE WHEN [MIKTAR] > 100 THEN NULL ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS]) END, 4) 
            OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_CEVRIM_4,
        
        LAG([LOGICALREF], 5) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_LOGICALREF_5,
        LAG([BASLANGIC], 5) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BASLANGIC_5,
        LAG([BITIS], 5) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_BITIS_5,
        LAG([MIKTAR], 5) OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_MIKTAR_5,
        LAG(CASE WHEN [MIKTAR] > 100 THEN NULL ELSE DATEDIFF(SECOND, [BASLANGIC], [BITIS]) END, 5) 
            OVER (PARTITION BY [MAKINE_NO] ORDER BY [LOGICALREF]) as ONCEKI_CEVRIM_5
    FROM AllMachines
)
SELECT 
    [MAKINE_NO],
    [LOGICALREF] as SON_LOGICALREF,
    CASE 
        WHEN [MIKTAR] <= 100 AND CEVRIM_SURESI <= 50 THEN [BASLANGIC]
        WHEN ONCEKI_MIKTAR_1 <= 100 AND ONCEKI_CEVRIM_1 <= 50 THEN ONCEKI_BASLANGIC_1
        WHEN ONCEKI_MIKTAR_2 <= 100 AND ONCEKI_CEVRIM_2 <= 50 THEN ONCEKI_BASLANGIC_2
        WHEN ONCEKI_MIKTAR_3 <= 100 AND ONCEKI_CEVRIM_3 <= 50 THEN ONCEKI_BASLANGIC_3
        WHEN ONCEKI_MIKTAR_4 <= 100 AND ONCEKI_CEVRIM_4 <= 50 THEN ONCEKI_BASLANGIC_4
        WHEN ONCEKI_MIKTAR_5 <= 100 AND ONCEKI_CEVRIM_5 <= 50 THEN ONCEKI_BASLANGIC_5
        ELSE NULL
    END as BASLANGIC,
    CASE 
        WHEN [MIKTAR] <= 100 AND CEVRIM_SURESI <= 50 THEN [BITIS]
        WHEN ONCEKI_MIKTAR_1 <= 100 AND ONCEKI_CEVRIM_1 <= 50 THEN ONCEKI_BITIS_1
        WHEN ONCEKI_MIKTAR_2 <= 100 AND ONCEKI_CEVRIM_2 <= 50 THEN ONCEKI_BITIS_2
        WHEN ONCEKI_MIKTAR_3 <= 100 AND ONCEKI_CEVRIM_3 <= 50 THEN ONCEKI_BITIS_3
        WHEN ONCEKI_MIKTAR_4 <= 100 AND ONCEKI_CEVRIM_4 <= 50 THEN ONCEKI_BITIS_4
        WHEN ONCEKI_MIKTAR_5 <= 100 AND ONCEKI_CEVRIM_5 <= 50 THEN ONCEKI_BITIS_5
        ELSE NULL
    END as BITIS,
    CASE 
        WHEN [MIKTAR] <= 100 AND CEVRIM_SURESI <= 50 THEN 
            CAST(DATEDIFF(SECOND, [BASLANGIC], [BITIS]) as VARCHAR) + '.' +
            RIGHT('000' + CAST(DATEDIFF(MILLISECOND, [BASLANGIC], [BITIS]) % 1000 as VARCHAR), 3)
        WHEN ONCEKI_MIKTAR_1 <= 100 AND ONCEKI_CEVRIM_1 <= 50 THEN 
            CAST(ONCEKI_CEVRIM_1 as VARCHAR) + '.000'
        WHEN ONCEKI_MIKTAR_2 <= 100 AND ONCEKI_CEVRIM_2 <= 50 THEN 
            CAST(ONCEKI_CEVRIM_2 as VARCHAR) + '.000'
        WHEN ONCEKI_MIKTAR_3 <= 100 AND ONCEKI_CEVRIM_3 <= 50 THEN 
            CAST(ONCEKI_CEVRIM_3 as VARCHAR) + '.000'
        WHEN ONCEKI_MIKTAR_4 <= 100 AND ONCEKI_CEVRIM_4 <= 50 THEN 
            CAST(ONCEKI_CEVRIM_4 as VARCHAR) + '.000'
        WHEN ONCEKI_MIKTAR_5 <= 100 AND ONCEKI_CEVRIM_5 <= 50 THEN 
            CAST(ONCEKI_CEVRIM_5 as VARCHAR) + '.000'
        ELSE NULL
    END as GERCEK_CEVRIM_SURESI,
    CASE 
        WHEN [MIKTAR] <= 100 AND CEVRIM_SURESI <= 50 THEN [MIKTAR]
        WHEN ONCEKI_MIKTAR_1 <= 100 AND ONCEKI_CEVRIM_1 <= 50 THEN ONCEKI_MIKTAR_1
        WHEN ONCEKI_MIKTAR_2 <= 100 AND ONCEKI_CEVRIM_2 <= 50 THEN ONCEKI_MIKTAR_2
        WHEN ONCEKI_MIKTAR_3 <= 100 AND ONCEKI_CEVRIM_3 <= 50 THEN ONCEKI_MIKTAR_3
        WHEN ONCEKI_MIKTAR_4 <= 100 AND ONCEKI_CEVRIM_4 <= 50 THEN ONCEKI_MIKTAR_4
        WHEN ONCEKI_MIKTAR_5 <= 100 AND ONCEKI_CEVRIM_5 <= 50 THEN ONCEKI_MIKTAR_5
        ELSE 0
    END as MIKTAR,
    CASE 
        WHEN [MIKTAR] <= 100 AND CEVRIM_SURESI <= 50 THEN 'Son Kayıt Kullanıldı'
        WHEN ONCEKI_MIKTAR_1 <= 100 AND ONCEKI_CEVRIM_1 <= 50 THEN '1 Önceki Kayıt Kullanıldı'
        WHEN ONCEKI_MIKTAR_2 <= 100 AND ONCEKI_CEVRIM_2 <= 50 THEN '2 Önceki Kayıt Kullanıldı'
        WHEN ONCEKI_MIKTAR_3 <= 100 AND ONCEKI_CEVRIM_3 <= 50 THEN '3 Önceki Kayıt Kullanıldı'
        WHEN ONCEKI_MIKTAR_4 <= 100 AND ONCEKI_CEVRIM_4 <= 50 THEN '4 Önceki Kayıt Kullanıldı'
        WHEN ONCEKI_MIKTAR_5 <= 100 AND ONCEKI_CEVRIM_5 <= 50 THEN '5 Önceki Kayıt Kullanıldı'
        ELSE 'Uygun Kayıt Bulunamadı'
    END as KAYIT_BILGISI
FROM RankedRecords
WHERE RowNum = 1;