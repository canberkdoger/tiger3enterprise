WITH VardiyaZamanlari AS (
    SELECT 
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
        END as VardiyaBaslangic,
        CASE 
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
            WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                 OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                     AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
            ELSE CAST(CONCAT(CAST(CAST(DATEADD(DAY, 1, DATEADD(HOUR, 3, GETUTCDATE())) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
        END as VardiyaBitis
)
SELECT        
    MES_DB_MAKINELER.MAKINEREF, 
    MES_DB_MAKINELER.MAKINE_KODU, 
    MES_DB_MAKINELER.MAKINE_ADI, 
    CASE 
        WHEN MES_DB_MAKINELER.MAKINE_KODU IN ('113', '114') THEN 'ŞEKER' 
        WHEN MES_DB_MAKINELER.MAKINE_KODU IN ('115', '116') THEN 'OYUNCAK' 
        WHEN MES_DB_MAKINELER.MAKINE_ADI LIKE '%STICKER%' THEN 'STICKER' 
        ELSE 'ENJEKSİYON' 
    END AS GRUP, 
    CASE 
        WHEN MES_DB_URETIMEMIRLERI.STATUS = 0 THEN 'ÇALIŞMIYOR - PLAN VAR' 
        WHEN MES_DB_URETIMEMIRLERI.STATUS = 1 THEN 'ÇALIŞIYOR' 
        WHEN MES_DB_URETIMEMIRLERI.STATUS = 2 THEN 'DURUŞ' 
        WHEN MES_DB_URETIMEMIRLERI.STATUS IS NULL THEN 'BOŞTA - PLAN YOK' 
    END AS DURUM, 
    CASE 
        WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) <= 0 THEN 'MİKTAR AŞILDI' 
        WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) <= MES_DB_URETIMEMIRLERI.PALET_ICI_MIKTAR THEN 'SON PALET' 
        ELSE NULL 
    END AS DURUM2, 
    CASE 
        WHEN MES_DB_URETIMEMIRLERI.STATUS = 2 THEN
            (SELECT TOP 1 TANIMI
            FROM MES_DB_DURUSLAR WITH (NOLOCK)
            WHERE ISTASYON = MES_DB_MAKINELER.MAKINEREF 
            AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF) 
        ELSE NULL 
    END AS DURUS_NEDENI, 
    MES_DB_URETIMEMIRLERI.URUN_KODU, 
    MES_DB_URETIMEMIRLERI.URUN_ADI, 
    MES_DB_URETIMEMIRLERI.KALIP_ADI, 
    MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR, 
    MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR, 
    MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR AS SAYAC_MIKTAR, 
    MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR) AS KALAN_MIKTAR,
    ISNULL(MUM.TOPLAM_MIKTAR, 0) as VARDIYA_MIKTAR,
    MES_DB_URETIMEMIRLERI.REFERANS_GOZ_SAYISI, 
    MES_DB_CEVRIM.MIKTAR AS GERCEK_GOZ_SAYISI, 
    MES_DB_URETIMEMIRLERI.REFERANS_CEVRIM, 
    MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, 
    MES_DB_URETIMEMIRLERI.BASLANGIC_ZAMANI, 
    DATEDIFF(MINUTE, MES_DB_URETIMEMIRLERI.BASLANGIC_ZAMANI, DATEADD(HOUR, 3, GETUTCDATE())) AS TOPLAM_CALISMA_SURESI, 
    CASE 
        WHEN (MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) <= 0 THEN NULL 
        ELSE DATEADD(SECOND, CEILING((MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR - MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR - (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)) 
        * CAST(REPLACE(MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, ',', '.') AS FLOAT) / MES_DB_CEVRIM.MIKTAR), DATEADD(HOUR, 3, GETUTCDATE())) 
    END AS BITIS_ZAMANI, 
    ISNULL(MES_DB_URETIMEMIRLERI.HURDA, 0) AS HURDA, 
    CASE 
        WHEN MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR > 0 THEN CAST((CAST(ISNULL(MES_DB_URETIMEMIRLERI.HURDA, 0) AS FLOAT) * 100.0) 
        / NULLIF (MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR + (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR), 0) AS DECIMAL(10, 2)) 
        ELSE 0 
    END AS FIRE_ORANI,
    ISNULL(MF.TOPLAM_MIKTAR, 0) as VARDIYA_HURDA,
    CASE 
        WHEN ISNULL(MUM.TOPLAM_MIKTAR, 0) > 0 
        THEN CAST((CAST(ISNULL(MF.TOPLAM_MIKTAR, 0) AS FLOAT) * 100.0) / NULLIF(MUM.TOPLAM_MIKTAR, 0) AS DECIMAL(10, 2))
        ELSE 0 
    END AS VARDIYA_FIRE_ORANI,
    (SELECT ISNULL(SUM(SURE_DAKIKA), 0)
    FROM MES_DB_DURUSLAR WITH (NOLOCK)
    WHERE ISTASYON = MES_DB_MAKINELER.MAKINEREF 
    AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF) AS DURUS_TOPLAM,
    (SELECT ISNULL(SUM(
        CASE 
            WHEN d.BASLANGIC >= v.VardiyaBaslangic AND d.BITIS IS NOT NULL AND d.BITIS <= DATEADD(HOUR, 3, GETUTCDATE())
                THEN d.SURE_DAKIKA
            WHEN d.BASLANGIC >= v.VardiyaBaslangic AND d.BASLANGIC <= DATEADD(HOUR, 3, GETUTCDATE()) AND d.BITIS IS NULL
                THEN DATEDIFF(MINUTE, d.BASLANGIC, DATEADD(HOUR, 3, GETUTCDATE()))
            WHEN d.BASLANGIC < v.VardiyaBaslangic AND d.BITIS IS NOT NULL AND d.BITIS <= DATEADD(HOUR, 3, GETUTCDATE())
                THEN DATEDIFF(MINUTE, v.VardiyaBaslangic, d.BITIS)
            WHEN d.BASLANGIC < v.VardiyaBaslangic AND d.BITIS IS NULL
                THEN DATEDIFF(MINUTE, v.VardiyaBaslangic, DATEADD(HOUR, 3, GETUTCDATE()))
            ELSE 0 
        END
    ), 0)
    FROM MES_DB_DURUSLAR d WITH (NOLOCK)
    CROSS JOIN VardiyaZamanlari v
    WHERE ISTASYON = MES_DB_MAKINELER.MAKINEREF 
    AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF
    AND (
        (d.BASLANGIC >= v.VardiyaBaslangic AND d.BASLANGIC <= DATEADD(HOUR, 3, GETUTCDATE()))
        OR 
        (d.BASLANGIC < v.VardiyaBaslangic AND (d.BITIS IS NULL OR d.BITIS > v.VardiyaBaslangic))
)) AS DURUS_VARDIYA,
    ISNULL(MUM.SON_PERSONEL, 'Tanımsız') as PERSONEL,
    /* Add OEE calculation*/ 
    CASE WHEN NULLIF (CAST(REPLACE(MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, ',', '.') AS FLOAT), 0) IS NULL OR
    NULLIF (DATEDIFF(MINUTE, MES_DB_URETIMEMIRLERI.BASLANGIC_ZAMANI, DATEADD(HOUR, 3, GETUTCDATE())), 0) IS NULL THEN 0 
    ELSE CAST((CAST(MES_DB_URETIMEMIRLERI.REFERANS_CEVRIM AS FLOAT) 
    / CAST(REPLACE(MES_DB_CEVRIM.GERCEK_CEVRIM_SURESI, ',', '.') AS FLOAT)) * /* Performans*/ 
    (1 - (CAST((SELECT ISNULL(SUM(SURE_DAKIKA), 0)
               FROM MES_DB_DURUSLAR WITH (NOLOCK)
               WHERE ISTASYON = MES_DB_MAKINELER.MAKINEREF 
               AND DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF) AS FLOAT) 
          / NULLIF (DATEDIFF(MINUTE, MES_DB_URETIMEMIRLERI.BASLANGIC_ZAMANI, DATEADD(HOUR, 3, GETUTCDATE())), 0))) * /* Kullanılabilirlik*/ 
    (1 - CASE WHEN MES_DB_URETIMEMIRLERI.PLANLANAN_MIKTAR > 0 
              THEN CAST((CAST(ISNULL(MES_DB_URETIMEMIRLERI.HURDA, 0) AS FLOAT)) 
              / NULLIF ((MES_DB_URETIMEMIRLERI.GERCEKLESEN_MIKTAR + (MES_DB_URETIMEMIRLERI.SAYAC * MES_DB_CEVRIM.MIKTAR)), 0) AS DECIMAL(10, 4)) 
              ELSE 0 END) * 100 AS DECIMAL(10, 2)) /* Kalite*/ 
    END AS OEE
FROM MES_DB_MAKINELER WITH (NOLOCK) 
LEFT OUTER JOIN MES_DB_URETIMEMIRLERI WITH (NOLOCK) 
    ON MES_DB_MAKINELER.MAKINEREF = MES_DB_URETIMEMIRLERI.ISTASYON 
LEFT OUTER JOIN MES_DB_CEVRIM WITH (NOLOCK) 
    ON MES_DB_MAKINELER.MAKINEREF = MES_DB_CEVRIM.MAKINE_NO
LEFT JOIN MES_DB_URETIMMIKTAR MUM WITH (NOLOCK)
    ON MUM.ISTASYON = MES_DB_MAKINELER.MAKINEREF
    AND MUM.DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF
LEFT JOIN (
    SELECT 
        ISTASYONREF,
        DISPLINEREF,
        SUM(TOPLAM_MIKTAR) as TOPLAM_MIKTAR
    FROM MES_DB_FIRE WITH (NOLOCK)
    CROSS JOIN (
        SELECT 
            CASE                             
                WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                     OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                         AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                    THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
                WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                     OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                         AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                    THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
                ELSE CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
            END as VardiyaBaslangic,
            CASE                             
                WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 8 
                     OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 8 
                         AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                    THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 08:30:00') AS DATETIME)
                WHEN DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) < 16 
                     OR (DATEPART(HOUR, DATEADD(HOUR, 3, GETUTCDATE())) = 16 
                         AND DATEPART(MINUTE, DATEADD(HOUR, 3, GETUTCDATE())) < 30)
                    THEN CAST(CONCAT(CAST(CAST(DATEADD(HOUR, 3, GETUTCDATE()) AS DATE) AS VARCHAR), ' 16:30:00') AS DATETIME)
                ELSE CAST(CONCAT(CAST(CAST(DATEADD(DAY, 1, DATEADD(HOUR, 3, GETUTCDATE())) AS DATE) AS VARCHAR), ' 00:30:00') AS DATETIME)
            END as VardiyaBitis
    ) v
    WHERE SON_ZAMAN >= v.VardiyaBaslangic 
    AND SON_ZAMAN < v.VardiyaBitis
    GROUP BY ISTASYONREF, DISPLINEREF
) MF
    ON MF.ISTASYONREF = MES_DB_MAKINELER.MAKINEREF
    AND MF.DISPLINEREF = MES_DB_URETIMEMIRLERI.DT_DISPLINEREF
WHERE MES_DB_MAKINELER.MAKINE_ADI NOT IN ('FASON', 'MONTAJ');