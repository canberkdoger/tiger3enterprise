WITH CombinedData AS (
    SELECT 
        '125' AS Year, 
        LOGICALREF,
        STOCKREF,
        STFICHEREF,
        DATE_,
        FTIME,
        AMOUNT
    FROM dbo.LG_125_01_STLINE
    UNION ALL
    SELECT 
        '124',
        LOGICALREF,
        STOCKREF,
        STFICHEREF,
        DATE_,
        FTIME,
        AMOUNT
    FROM dbo.LG_124_01_STLINE
    UNION ALL
    SELECT 
        '122',
        LOGICALREF,
        STOCKREF,
        STFICHEREF,
        DATE_,
        FTIME,
        AMOUNT
    FROM dbo.LG_122_01_STLINE
)
SELECT
    CASE COALESCE(STFICHE.SOURCEINDEX, STFICHE_124.SOURCEINDEX, STFICHE_122.SOURCEINDEX)
        WHEN 0 THEN 'B. Merkez'
        WHEN 1 THEN 'B. Üretim'
        WHEN 2 THEN 'B. İade Ambarı'
        WHEN 3 THEN 'B. Karantina Depo'
        WHEN 4 THEN 'Erport Antrepo'
        WHEN 5 THEN 'Goker Antrepo'
        WHEN 6 THEN 'Aktas Paketleme'
        WHEN 7 THEN 'S. Merkez'
        WHEN 8 THEN 'S. Üretim'
        WHEN 9 THEN 'B. Giriş Kalite Kontrol'
        WHEN 10 THEN 'S. Giriş Kalite Kontrol'
        WHEN 11 THEN 'S. İade Ambarı'
        WHEN 13 THEN 'S. Karantina Depo'
        WHEN 14 THEN 'B.Teknik Malzeme'
        WHEN 15 THEN 'S.Teknik Malzeme'
        WHEN 50 THEN 'YOLDA'
        WHEN 100 THEN 'LIZ PAKETLEME'
        WHEN 101 THEN 'DAV MAKİNE'
        WHEN 102 THEN 'Hurda'
        ELSE 'Bilinmeyen Ambar'
    END AS [Ambar Adı],
    CASE
        WHEN LEFT(COALESCE(ITEMS.CODE, ITEMS_124.CODE, ITEMS_122.CODE), 1) = '\' 
        THEN SUBSTRING(COALESCE(ITEMS.CODE, ITEMS_124.CODE, ITEMS_122.CODE), 2, LEN(COALESCE(ITEMS.CODE, ITEMS_124.CODE, ITEMS_122.CODE)) - 1)
        ELSE COALESCE(ITEMS.CODE, ITEMS_124.CODE, ITEMS_122.CODE)
    END AS [Malzeme Kodu],
    COALESCE(ITEMS.NAME, ITEMS_124.NAME, ITEMS_122.NAME) AS [Malzeme Adı],
    COALESCE(ITEMS.SPECODE, ITEMS_124.SPECODE, ITEMS_122.SPECODE) AS [Özel Kod],
    COALESCE(ITEMS.SPECODE3, ITEMS_124.SPECODE3, ITEMS_122.SPECODE3) AS [Özel Kod 3],
    COALESCE(SPECODES.DEFINITION_, SPECODES_124.DEFINITION_, SPECODES_122.DEFINITION_) AS [Özel Kod 3 Açıklaması],
    STLINE.DATE_ AS [Tarih],
    dbo.LG_INTTOTIME(STLINE.FTIME) AS [Saat],
    CASE COALESCE(STFICHE.TRCODE, STFICHE_124.TRCODE, STFICHE_122.TRCODE)
        WHEN 1 THEN 'Mal alım irsaliyesi'
        WHEN 2 THEN 'Per. sat. iade irs.'
        WHEN 3 THEN 'Topt.sat. iade irs.'
        WHEN 4 THEN 'Kons. çıkış iade irs.'
        WHEN 5 THEN 'Konsinye giriş irs.'
        WHEN 6 THEN 'Alım iade irs.'
        WHEN 7 THEN 'Perakende satış irs.'
        WHEN 8 THEN 'Toptan satış irs.'
        WHEN 9 THEN 'Konsinye çıkış irs.'
        WHEN 10 THEN 'Konsinye giriş iade irs.'
        WHEN 11 THEN 'Fire fişi'
        WHEN 12 THEN 'Sarf fişi'
        WHEN 13 THEN 'üretimden giriş fişi'
        WHEN 14 THEN 'Devir fişi'
        WHEN 25 THEN 'Ambar fişi'
        WHEN 26 THEN 'Mustahsil irs.'
        WHEN 50 THEN 'Sayım Fazlası Fişi'
        WHEN 51 THEN 'Sayım Eksiği Fişi'
        ELSE 'Bilinmeyen Hareket Türü'
    END AS [Hareket Türü],
    STLINE.AMOUNT AS [Miktar],
    COALESCE(STFICHE.FICHENO, STFICHE_124.FICHENO, STFICHE_122.FICHENO) AS [Fiş No]
FROM 
    CombinedData AS STLINE
LEFT JOIN 
    dbo.LG_125_ITEMS AS ITEMS ON STLINE.Year = '125' AND STLINE.STOCKREF = ITEMS.LOGICALREF
LEFT JOIN 
    dbo.LG_124_ITEMS AS ITEMS_124 ON STLINE.Year = '124' AND STLINE.STOCKREF = ITEMS_124.LOGICALREF
LEFT JOIN 
    dbo.LG_122_ITEMS AS ITEMS_122 ON STLINE.Year = '122' AND STLINE.STOCKREF = ITEMS_122.LOGICALREF
LEFT JOIN 
    dbo.LG_125_01_STFICHE AS STFICHE ON STLINE.Year = '125' AND STLINE.STFICHEREF = STFICHE.LOGICALREF
LEFT JOIN 
    dbo.LG_124_01_STFICHE AS STFICHE_124 ON STLINE.Year = '124' AND STLINE.STFICHEREF = STFICHE_124.LOGICALREF
LEFT JOIN 
    dbo.LG_122_01_STFICHE AS STFICHE_122 ON STLINE.Year = '122' AND STLINE.STFICHEREF = STFICHE_122.LOGICALREF
LEFT JOIN 
    dbo.LG_125_SPECODES AS SPECODES ON COALESCE(ITEMS.SPECODE3, ITEMS_124.SPECODE3, ITEMS_122.SPECODE3) = SPECODES.SPECODE 
    AND SPECODES.SPECODETYPE = 1
LEFT JOIN 
    dbo.LG_124_SPECODES AS SPECODES_124 ON COALESCE(ITEMS.SPECODE3, ITEMS_124.SPECODE3, ITEMS_122.SPECODE3) = SPECODES_124.SPECODE 
    AND SPECODES_124.SPECODETYPE = 1
LEFT JOIN 
    dbo.LG_122_SPECODES AS SPECODES_122 ON COALESCE(ITEMS.SPECODE3, ITEMS_124.SPECODE3, ITEMS_122.SPECODE3) = SPECODES_122.SPECODE 
    AND SPECODES_122.SPECODETYPE = 1
WHERE 
    YEAR(STLINE.DATE_) IN (2022, 2023, 2024, 2025)
    AND COALESCE(STFICHE.FICHENO, STFICHE_124.FICHENO, STFICHE_122.FICHENO) IS NOT NULL
    AND COALESCE(STFICHE.SOURCEINDEX, STFICHE_124.SOURCEINDEX, STFICHE_122.SOURCEINDEX) IS NOT NULL
    AND COALESCE(STFICHE.TRCODE, STFICHE_124.TRCODE, STFICHE_122.TRCODE) IS NOT NULL
    AND COALESCE(ITEMS.CODE, ITEMS_124.CODE, ITEMS_122.CODE) IS NOT NULL