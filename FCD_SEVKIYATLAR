WITH CombinedData AS (
    SELECT 
        STLINE.DATE_,
        STLINE.FTIME,
        STLINE.AMOUNT,
        STLINE.VATMATRAH,
        STLINE.REPORTRATE,
        STFICHE.TRCODE,
        STFICHE.PRODSTAT,
        STFICHE.CANCELLED,
        STFICHE.FICHENO,
        ITEMS.CODE,
        ITEMS.NAME,
        ITEMS.CARDTYPE,
        ITEMS.SPECODE3,
        SPECODES.DEFINITION_ AS SPECODE3_DESC,
        CLCARD.CODE AS CLIENTCODE,
        CLCARD.DEFINITION_ AS CLIENTNAME,
        MB.[Net Ağırlık] AS NET_WEIGHT
    FROM dbo.LG_125_01_STLINE STLINE
    LEFT JOIN dbo.LG_125_ITEMS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF
    LEFT JOIN dbo.LG_125_01_STFICHE STFICHE ON STLINE.STFICHEREF = STFICHE.LOGICALREF
    LEFT JOIN dbo.LG_125_CLCARD CLCARD ON STLINE.CLIENTREF = CLCARD.LOGICALREF
    LEFT JOIN dbo.LG_125_SPECODES SPECODES ON ITEMS.SPECODE3 = SPECODES.SPECODE AND SPECODES.SPECODETYPE = 1
    LEFT JOIN dbo.FCD_MALZEMEBIRIMLER MB ON MB.[Ürün Kodu] = ITEMS.CODE
    WHERE ITEMS.CARDTYPE = 12
    
    UNION ALL
    
    SELECT 
        STLINE.DATE_,
        STLINE.FTIME,
        STLINE.AMOUNT,
        STLINE.VATMATRAH,
        STLINE.REPORTRATE,
        STFICHE.TRCODE,
        STFICHE.PRODSTAT,
        STFICHE.CANCELLED,
        STFICHE.FICHENO,
        ITEMS.CODE,
        ITEMS.NAME,
        ITEMS.CARDTYPE,
        ITEMS.SPECODE3,
        SPECODES.DEFINITION_ AS SPECODE3_DESC,
        CLCARD.CODE AS CLIENTCODE,
        CLCARD.DEFINITION_ AS CLIENTNAME,
        MB.[Net Ağırlık] AS NET_WEIGHT
    FROM dbo.LG_124_01_STLINE STLINE
    LEFT JOIN dbo.LG_124_ITEMS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF
    LEFT JOIN dbo.LG_124_01_STFICHE STFICHE ON STLINE.STFICHEREF = STFICHE.LOGICALREF
    LEFT JOIN dbo.LG_124_CLCARD CLCARD ON STLINE.CLIENTREF = CLCARD.LOGICALREF
    LEFT JOIN dbo.LG_124_SPECODES SPECODES ON ITEMS.SPECODE3 = SPECODES.SPECODE AND SPECODES.SPECODETYPE = 1
    LEFT JOIN dbo.FCD_MALZEMEBIRIMLER MB ON MB.[Ürün Kodu] = ITEMS.CODE
    WHERE ITEMS.CARDTYPE = 12
    
    UNION ALL
    
    SELECT 
        STLINE.DATE_,
        STLINE.FTIME,
        STLINE.AMOUNT,
        STLINE.VATMATRAH,
        STLINE.REPORTRATE,
        STFICHE.TRCODE,
        STFICHE.PRODSTAT,
        STFICHE.CANCELLED,
        STFICHE.FICHENO,
        ITEMS.CODE,
        ITEMS.NAME,
        ITEMS.CARDTYPE,
        ITEMS.SPECODE3,
        SPECODES.DEFINITION_ AS SPECODE3_DESC,
        CLCARD.CODE AS CLIENTCODE,
        CLCARD.DEFINITION_ AS CLIENTNAME,
        MB.[Net Ağırlık] AS NET_WEIGHT
    FROM dbo.LG_122_01_STLINE STLINE
    LEFT JOIN dbo.LG_122_ITEMS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF
    LEFT JOIN dbo.LG_122_01_STFICHE STFICHE ON STLINE.STFICHEREF = STFICHE.LOGICALREF
    LEFT JOIN dbo.LG_122_CLCARD CLCARD ON STLINE.CLIENTREF = CLCARD.LOGICALREF
    LEFT JOIN dbo.LG_122_SPECODES SPECODES ON ITEMS.SPECODE3 = SPECODES.SPECODE AND SPECODES.SPECODETYPE = 1
    LEFT JOIN dbo.FCD_MALZEMEBIRIMLER MB ON MB.[Ürün Kodu] = ITEMS.CODE
    WHERE ITEMS.CARDTYPE = 12

    UNION ALL

    SELECT 
        ORFICHE.DATE_,
        NULL AS FTIME,
        ORFLINE.AMOUNT,
        ORFLINE.TOTAL AS VATMATRAH,
        ORFICHE.REPORTRATE,
        8 AS TRCODE,
        0 AS PRODSTAT,
        0 AS CANCELLED,
        ORFICHE.GENEXP1 AS FICHENO,
        ITEMS.CODE,
        ITEMS.NAME,
        ITEMS.CARDTYPE,
        ITEMS.SPECODE3,
        SPECODES.DEFINITION_ AS SPECODE3_DESC,
        CLCARD.CODE AS CLIENTCODE,
        CLCARD.DEFINITION_ AS CLIENTNAME,
        MB.[Net Ağırlık] AS NET_WEIGHT
    FROM dbo.LG_125_01_ORFLINE ORFLINE
    LEFT JOIN dbo.LG_125_ITEMS ITEMS ON ORFLINE.STOCKREF = ITEMS.LOGICALREF
    LEFT JOIN dbo.LG_125_01_ORFICHE ORFICHE ON ORFLINE.ORDFICHEREF = ORFICHE.LOGICALREF
    LEFT JOIN dbo.LG_125_CLCARD CLCARD ON ORFLINE.CLIENTREF = CLCARD.LOGICALREF
    LEFT JOIN dbo.LG_125_SPECODES SPECODES ON ITEMS.SPECODE3 = SPECODES.SPECODE AND SPECODES.SPECODETYPE = 1
    LEFT JOIN dbo.FCD_MALZEMEBIRIMLER MB ON MB.[Ürün Kodu] = ITEMS.CODE
    WHERE ITEMS.CARDTYPE = 12 
    AND ORFLINE.CLOSED = 0 
    AND ORFLINE.TRCODE = 1 
    AND ORFICHE.SPECODE = 'IHRTESLIM'
)
SELECT
    CASE
        WHEN LEFT(CD.CODE, 1) = '\' 
        THEN SUBSTRING(CD.CODE, 2, LEN(CD.CODE) - 1)
        ELSE CD.CODE
    END AS [Malzeme Kodu],
    CD.NAME AS [Malzeme Adı],
    CD.SPECODE3 AS [Özel Kod 3],
    CD.SPECODE3_DESC AS [Özel Kod 3 Açıklaması],
    CD.DATE_ AS [Tarih],
    dbo.LG_INTTOTIME(CD.FTIME) AS [Saat],
    CASE CD.TRCODE
        WHEN 8 THEN 'Toptan satış irs.'
        WHEN 3 THEN 'Topt.sat. iade irs.'
    END AS [Hareket Türü],
    CD.CLIENTCODE AS [Cari Kodu],
    CD.CLIENTNAME AS [Cari Adı],
    CASE 
        WHEN CD.TRCODE = 3 THEN -1 * CD.AMOUNT
        ELSE CD.AMOUNT
    END AS [Miktar],
    CASE 
        WHEN CD.TRCODE = 3 THEN -1 * [dbo].[safeDivide](CD.VATMATRAH, CD.AMOUNT)
        ELSE [dbo].[safeDivide](CD.VATMATRAH, CD.AMOUNT)
    END AS [Fiyat TL],
    CASE 
        WHEN CD.TRCODE = 3 THEN -1 * [dbo].[safeDivide]([dbo].[safeDivide](CD.VATMATRAH, CD.AMOUNT), CD.REPORTRATE)
        ELSE [dbo].[safeDivide]([dbo].[safeDivide](CD.VATMATRAH, CD.AMOUNT), CD.REPORTRATE)
    END AS [Fiyat EUR],
    CASE 
        WHEN CD.TRCODE = 3 THEN -1 * CD.VATMATRAH
        ELSE CD.VATMATRAH
    END AS [Toplam TL],
    CASE 
        WHEN CD.TRCODE = 3 THEN -1 * [dbo].[safeDivide](CD.VATMATRAH, CD.REPORTRATE)
        ELSE [dbo].[safeDivide](CD.VATMATRAH, CD.REPORTRATE)
    END AS [Toplam EUR],
    CD.FICHENO AS [Fiş No],
    CASE 
        WHEN CD.FICHENO IN (SELECT GENEXP1 FROM dbo.LG_125_01_ORFICHE WHERE SPECODE = 'IHRTESLIM') THEN 'YURTDIŞI TESLİMAT'
        WHEN CD.CLIENTCODE IN ('120.002.00028G8P', '120.002.00028EUR', '120.002.00028GBP', '120.002.00015') THEN 'YURTDIŞI SEVKİYAT'
        ELSE 'STANDART'
    END AS [Sevkiyat Tipi],
    CASE
        WHEN CD.NET_WEIGHT IS NULL THEN 0
        ELSE CD.NET_WEIGHT / 1000.0
    END AS [Birim Ağırlık],
    CASE
        WHEN CD.NET_WEIGHT IS NULL THEN 0
        ELSE (CD.NET_WEIGHT / 1000.0) * 
            CASE 
                WHEN CD.TRCODE = 3 THEN -1 * CD.AMOUNT
                ELSE CD.AMOUNT
            END
    END AS [Toplam Ağırlık]
FROM 
    CombinedData CD
WHERE 
    (CD.TRCODE IN (3, 8)  -- Sadece Toptan satış ve Toptan satış iade
    AND CD.PRODSTAT = 0  -- Sadece güncel olanlar
    AND CD.CANCELLED = 0) -- Sadece aktif olanlar