SELECT  dbo.FCD_RECETE.[HAMMADDE KODU] AS HM_KODU, 
        MAX(dbo.FCD_RECETE.[HAMMADDE ADI]) AS HM_ADI, 
        MAX(dbo.FCD_RECETE.[HAMMADDE TÜRÜ]) AS HM_TURU, 
        MAX(dbo.FCD_RECETE.BİRİM) AS BIRIM,
        SUM(CASE 
            WHEN dbo.FCD_RECETE.[GÖZ SAYISI] = 0 OR dbo.FCD_RECETE.[GÖZ SAYISI] IS NULL 
            THEN dbo.FCD_RECETE.MİKTAR 
            ELSE dbo.FCD_RECETE.MİKTAR / dbo.FCD_RECETE.[GÖZ SAYISI] 
        END * dbo.FCD_MES_URETILECEKMIKTAR.URETILECEK_MIKTAR) AS TOPLAM_SARF,
        ISNULL(MAX(dbo.FCD_DEPOMIKTARHAMMADDE.[S. Üretim]), 0) AS URETIM_STOK,
        (SUM(CASE 
            WHEN dbo.FCD_RECETE.[GÖZ SAYISI] = 0 OR dbo.FCD_RECETE.[GÖZ SAYISI] IS NULL 
            THEN dbo.FCD_RECETE.MİKTAR 
            ELSE dbo.FCD_RECETE.MİKTAR / dbo.FCD_RECETE.[GÖZ SAYISI] 
        END * dbo.FCD_MES_URETILECEKMIKTAR.URETILECEK_MIKTAR) - 
        ISNULL(MAX(dbo.FCD_DEPOMIKTARHAMMADDE.[S. Üretim]), 0)) AS IHTIYAC,
        ISNULL(MAX(dbo.FCD_DEPOMIKTARHAMMADDE.[S. Merkez]), 0) AS MERKEZ_STOK
FROM    dbo.FCD_MES_URETILECEKMIKTAR 
        INNER JOIN dbo.FCD_RECETE 
            ON dbo.FCD_MES_URETILECEKMIKTAR.RECETE_KODU = dbo.FCD_RECETE.[REÇETE KODU] 
            AND dbo.FCD_RECETE.[HAMMADDE TÜRÜ] NOT IN ('s') 
        LEFT OUTER JOIN dbo.FCD_DEPOMIKTARHAMMADDE 
            ON dbo.FCD_RECETE.[HAMMADDE KODU] = dbo.FCD_DEPOMIKTARHAMMADDE.[MALZEME KODU]
GROUP BY dbo.FCD_RECETE.[HAMMADDE KODU]
HAVING (SUM(CASE 
            WHEN dbo.FCD_RECETE.[GÖZ SAYISI] = 0 OR dbo.FCD_RECETE.[GÖZ SAYISI] IS NULL 
            THEN dbo.FCD_RECETE.MİKTAR 
            ELSE dbo.FCD_RECETE.MİKTAR / dbo.FCD_RECETE.[GÖZ SAYISI] 
        END * dbo.FCD_MES_URETILECEKMIKTAR.URETILECEK_MIKTAR) - 
        ISNULL(MAX(dbo.FCD_DEPOMIKTARHAMMADDE.[S. Üretim]), 0)) > 0