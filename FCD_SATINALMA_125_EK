WITH SLTRANS AS (
    SELECT 
        LOGICALREF, 
        STFICHEREF, 
        SLREF,
        ROW_NUMBER() OVER (PARTITION BY STFICHEREF ORDER BY LOGICALREF) AS LNNO
    FROM dbo.LG_125_01_SLTRANS
),
SERILOTN AS (
    SELECT LOGICALREF, CODE
    FROM dbo.LG_125_01_SERILOTN
),
ESKIKOD AS (
    SELECT LOT_BASLANGIC, ESKI_KOD
    FROM dbo.ESKIKODLAR
),
STLINE_EXTENDED AS (
    SELECT STLINE.*, 
           CASE 
               WHEN ITEMS.SPECODE = 'hm' AND ESKIKOD.LOT_BASLANGIC IS NOT NULL THEN ESKIKOD.ESKI_KOD 
               ELSE ITEMS.CODE 
           END AS [Yeni Malzeme Kodu],
           CASE 
               WHEN ITEMS.SPECODE = 'hm' AND ESKIKOD.LOT_BASLANGIC IS NOT NULL THEN 'E.K. Kullanıldı' 
               ELSE NULL 
           END AS [E.K. Kullanıldı],
           SERILOTN.CODE AS [Seri Lot Kodu]
    FROM dbo.LG_125_01_STLINE AS STLINE
    LEFT JOIN dbo.LG_125_ITEMS AS ITEMS ON STLINE.STOCKREF = ITEMS.LOGICALREF
    LEFT JOIN SLTRANS ON STLINE.STFICHEREF = SLTRANS.STFICHEREF AND STLINE.STFICHELNNO = SLTRANS.LNNO
    LEFT JOIN SERILOTN ON SLTRANS.SLREF = SERILOTN.LOGICALREF
    LEFT JOIN ESKIKOD ON LEFT(SERILOTN.CODE, LEN(ESKIKOD.LOT_BASLANGIC)) = ESKIKOD.LOT_BASLANGIC
)
SELECT 
    CASE WHEN LEFT(STLINE_EXTENDED.[Yeni Malzeme Kodu], 1) = '\' THEN SUBSTRING(STLINE_EXTENDED.[Yeni Malzeme Kodu], 2, LEN(STLINE_EXTENDED.[Yeni Malzeme Kodu]) - 1) ELSE STLINE_EXTENDED.[Yeni Malzeme Kodu] END AS [Malzeme Kodu], 
    ISNULL(NEW_ITEMS.NAME, ITEMS.NAME) AS [Malzeme Adı],
    ITEMS.SPECODE AS [Özel Kod],
    ITEMS.SPECODE3 AS [Özel Kod 3],
    SPECODES.DEFINITION_ AS [Özel Kod 3 Açıklaması], 
    STLINE_EXTENDED.DATE_ AS Tarih, 
    dbo.LG_INTTOTIME(STLINE_EXTENDED.FTIME) AS Saat, 
    CASE STFICHE.TRCODE 
        WHEN 1 THEN 'Mal alım irsaliyesi' 
        WHEN 2 THEN 'Per. sat. iade irs.' 
        WHEN 3 THEN 'Topt.sat. iade irs.' 
        WHEN 4 THEN 'Kons. çıkış iade irs.' 
        WHEN 5 THEN 'Konsinye giriş irs.' 
        WHEN 6 THEN 'Alım iade irs.'
        WHEN 7 THEN 'Perakende satış irs.' 
        WHEN 8 THEN 'Toptan satış irs.' 
        WHEN 9 THEN 'Konsinye çıkış irs.' 
        WHEN 10 THEN 'Konsinye giriş iade irs.' 
        WHEN 11 THEN 'Fire fişi' 
        WHEN 12 THEN 'Sarf fişi' 
        WHEN 13 THEN 'üretimden giriş fişi'
        WHEN 14 THEN 'Devir fişi' 
        WHEN 25 THEN 'Ambar fişi' 
        WHEN 26 THEN 'Mustahsil irs.' 
        WHEN 50 THEN 'Sayım Fazlası Fişi' 
        WHEN 51 THEN 'Sayım Eksiği Fişi' 
        ELSE 'Bilinmeyen Hareket Türü' 
    END AS [Hareket Türü], 
    CASE STFICHE.PRODSTAT 
        WHEN 0 THEN 'Güncel' 
        WHEN 1 THEN 'Planlanan' 
        ELSE 'Belirsiz' 
    END AS Durumu, 
    CASE STFICHE.CANCELLED 
        WHEN 0 THEN 'Aktif' 
        WHEN 1 THEN 'İptal Edilmiş' 
        ELSE 'Belirsiz' 
    END AS [İptal Durumu], 
    STLINE_EXTENDED.AMOUNT AS Miktar, 
    CASE WHEN STFICHE.TRCODE = 3 THEN - 1 * [dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STLINE_EXTENDED.AMOUNT) ELSE [dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STLINE_EXTENDED.AMOUNT) END AS [Fiyat TL], 
    CASE WHEN STFICHE.TRCODE = 3 THEN - 1 * [dbo].[safeDivide]([dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STLINE_EXTENDED.AMOUNT), STFICHE.REPORTRATE) ELSE [dbo].[safeDivide]([dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STLINE_EXTENDED.AMOUNT), STFICHE.REPORTRATE) END AS [Fiyat EUR], 
    CASE WHEN STFICHE.TRCODE = 3 THEN - 1 * STLINE_EXTENDED.VATMATRAH ELSE STLINE_EXTENDED.VATMATRAH END AS [Toplam TL], 
    CASE WHEN STFICHE.TRCODE = 3 THEN - 1 * [dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STFICHE.REPORTRATE) ELSE [dbo].[safeDivide](STLINE_EXTENDED.VATMATRAH, STFICHE.REPORTRATE) END AS [Toplam EUR], 
    STFICHE.REPORTRATE AS Kur, 
    STFICHE.FICHENO AS [Fiş No], 
    dbo.LG_125_CLCARD.CODE, 
    dbo.LG_125_CLCARD.DEFINITION_, 
    STLINE_EXTENDED.[Seri Lot Kodu], 
    STLINE_EXTENDED.[E.K. Kullanıldı]
FROM 
    dbo.LG_125_CLCARD 
    INNER JOIN dbo.LG_125_01_STFICHE AS STFICHE ON dbo.LG_125_CLCARD.LOGICALREF = STFICHE.CLIENTREF 
    RIGHT OUTER JOIN STLINE_EXTENDED ON STFICHE.LOGICALREF = STLINE_EXTENDED.STFICHEREF
    LEFT OUTER JOIN dbo.LG_125_ITEMS AS ITEMS ON STLINE_EXTENDED.STOCKREF = ITEMS.LOGICALREF 
    LEFT OUTER JOIN dbo.LG_125_ITEMS AS NEW_ITEMS ON STLINE_EXTENDED.[Yeni Malzeme Kodu] = NEW_ITEMS.CODE 
    LEFT OUTER JOIN dbo.LG_125_SPECODES AS SPECODES ON ITEMS.SPECODE3 = SPECODES.SPECODE AND SPECODES.SPECODETYPE = 1
WHERE 
    (YEAR(STLINE_EXTENDED.DATE_) = 2025) 
    AND (STFICHE.SOURCEINDEX IS NOT NULL) 
    AND (STFICHE.TRCODE IS NOT NULL) 
    AND (STLINE_EXTENDED.[Yeni Malzeme Kodu] IS NOT NULL) 
    AND (STFICHE.TRCODE = 1);