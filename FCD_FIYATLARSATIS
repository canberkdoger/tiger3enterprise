WITH CurrentItemsCTE AS (
    SELECT 
        CASE WHEN I.CODE LIKE '\%' THEN SUBSTRING(I.CODE, 2, LEN(I.CODE) - 1) ELSE I.CODE END AS CODE,
        MAX(I.NAME) AS NAME,
        MAX(I.SPECODE3) AS MOULDCODE,
        MAX(SP.DEFINITION_) AS MOULDNAME
    FROM dbo.LG_125_ITEMS I
    LEFT JOIN dbo.LG_125_SPECODES SP ON I.SPECODE3 = SP.SPECODE
    WHERE I.CARDTYPE = 12
    GROUP BY CASE WHEN I.CODE LIKE '\%' THEN SUBSTRING(I.CODE, 2, LEN(I.CODE) - 1) ELSE I.CODE END
),
ItemsLogicalRefsCTE AS (
    SELECT DISTINCT 
        ci.CODE,
        i125.LOGICALREF AS REF_125,
        i124.LOGICALREF AS REF_124,
        i122.LOGICALREF AS REF_122
    FROM CurrentItemsCTE ci
    LEFT JOIN dbo.LG_125_ITEMS i125 ON 
        CASE WHEN i125.CODE LIKE '\%' THEN SUBSTRING(i125.CODE, 2, LEN(i125.CODE) - 1) ELSE i125.CODE END = ci.CODE
    LEFT JOIN dbo.LG_124_ITEMS i124 ON 
        CASE WHEN i124.CODE LIKE '\%' THEN SUBSTRING(i124.CODE, 2, LEN(i124.CODE) - 1) ELSE i124.CODE END = ci.CODE
    LEFT JOIN dbo.LG_122_ITEMS i122 ON 
        CASE WHEN i122.CODE LIKE '\%' THEN SUBSTRING(i122.CODE, 2, LEN(i122.CODE) - 1) ELSE i122.CODE END = ci.CODE
    WHERE i125.CARDTYPE = 12 OR i124.CARDTYPE = 12 OR i122.CARDTYPE = 12
),
Sales2025CTE AS (
    SELECT 
        ir.CODE,
        MONTH(ST.DATE_) AS MONTH_,
        SUM(ST.VATMATRAH) as TOTAL_VATMATRAH,
        SUM(ST.AMOUNT) as TOTAL_AMOUNT
    FROM ItemsLogicalRefsCTE ir
    INNER JOIN dbo.LG_125_01_STLINE ST ON ir.REF_125 = ST.STOCKREF
    INNER JOIN dbo.LG_125_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
    WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 
    AND ST.LINETYPE = 0
    AND YEAR(ST.DATE_) = 2025
    GROUP BY ir.CODE, MONTH(ST.DATE_)
),
Sales2024CTE AS (
    SELECT 
        ir.CODE,
        MONTH(ST.DATE_) AS MONTH_,
        SUM(ST.VATMATRAH) as TOTAL_VATMATRAH,
        SUM(ST.AMOUNT) as TOTAL_AMOUNT
    FROM ItemsLogicalRefsCTE ir
    INNER JOIN dbo.LG_124_01_STLINE ST ON ir.REF_124 = ST.STOCKREF
    INNER JOIN dbo.LG_124_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
    WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 
    AND ST.LINETYPE = 0
    AND YEAR(ST.DATE_) = 2024
    GROUP BY ir.CODE, MONTH(ST.DATE_)
),
Sales2023CTE AS (
    SELECT 
        ir.CODE,
        SUM(ST.VATMATRAH) as TOTAL_VATMATRAH,
        SUM(ST.AMOUNT) as TOTAL_AMOUNT
    FROM ItemsLogicalRefsCTE ir
    INNER JOIN dbo.LG_122_01_STLINE ST ON ir.REF_122 = ST.STOCKREF
    INNER JOIN dbo.LG_122_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
    WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 
    AND ST.LINETYPE = 0
    AND YEAR(ST.DATE_) = 2023
    GROUP BY ir.CODE
),
Sales2022CTE AS (
    SELECT 
        ir.CODE,
        SUM(ST.VATMATRAH) as TOTAL_VATMATRAH,
        SUM(ST.AMOUNT) as TOTAL_AMOUNT
    FROM ItemsLogicalRefsCTE ir
    INNER JOIN dbo.LG_122_01_STLINE ST ON ir.REF_122 = ST.STOCKREF
    INNER JOIN dbo.LG_122_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
    WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 
    AND ST.LINETYPE = 0
    AND YEAR(ST.DATE_) = 2022
    GROUP BY ir.CODE
),
LastPriceCTE AS (
    SELECT CODE, 
           VATMATRAH, 
           AMOUNT, 
           DATE_,
           ROW_NUMBER() OVER (PARTITION BY CODE ORDER BY DATE_ DESC) as RN
    FROM (
        SELECT ir.CODE,
               ST.VATMATRAH, 
               ST.AMOUNT, 
               ST.DATE_
        FROM ItemsLogicalRefsCTE ir
        JOIN dbo.LG_125_01_STLINE ST ON ir.REF_125 = ST.STOCKREF
        JOIN dbo.LG_125_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
        WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 AND ST.LINETYPE = 0
        UNION ALL
        SELECT ir.CODE,
               ST.VATMATRAH, 
               ST.AMOUNT, 
               ST.DATE_
        FROM ItemsLogicalRefsCTE ir
        JOIN dbo.LG_124_01_STLINE ST ON ir.REF_124 = ST.STOCKREF
        JOIN dbo.LG_124_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
        WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 AND ST.LINETYPE = 0
        UNION ALL
        SELECT ir.CODE,
               ST.VATMATRAH, 
               ST.AMOUNT, 
               ST.DATE_
        FROM ItemsLogicalRefsCTE ir
        JOIN dbo.LG_122_01_STLINE ST ON ir.REF_122 = ST.STOCKREF
        JOIN dbo.LG_122_01_INVOICE IV ON ST.INVOICEREF = IV.LOGICALREF
        WHERE IV.TRCODE = 8 AND IV.GRPCODE = 2 AND ST.LINETYPE = 0
    ) AS AllData
)
SELECT 
    i.CODE,
    i.NAME,
    i.MOULDCODE,
    i.MOULDNAME,
    -- 2025 aylık ağırlıklı ortalamalar
    MAX(CASE WHEN s25.MONTH_ = 1 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Jan2025,
    MAX(CASE WHEN s25.MONTH_ = 2 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Feb2025,
    MAX(CASE WHEN s25.MONTH_ = 3 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Mar2025,
    MAX(CASE WHEN s25.MONTH_ = 4 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Apr2025,
    MAX(CASE WHEN s25.MONTH_ = 5 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS May2025,
    MAX(CASE WHEN s25.MONTH_ = 6 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Jun2025,
    MAX(CASE WHEN s25.MONTH_ = 7 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Jul2025,
    MAX(CASE WHEN s25.MONTH_ = 8 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Aug2025,
    MAX(CASE WHEN s25.MONTH_ = 9 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Sep2025,
    MAX(CASE WHEN s25.MONTH_ = 10 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Oct2025,
    MAX(CASE WHEN s25.MONTH_ = 11 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Nov2025,
    MAX(CASE WHEN s25.MONTH_ = 12 THEN dbo.safeDivide(s25.TOTAL_VATMATRAH, s25.TOTAL_AMOUNT) END) AS Dec2025,
    -- 2024 aylık ağırlıklı ortalamalar
    MAX(CASE WHEN s24.MONTH_ = 1 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Jan2024,
    MAX(CASE WHEN s24.MONTH_ = 2 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Feb2024,
    MAX(CASE WHEN s24.MONTH_ = 3 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Mar2024,
    MAX(CASE WHEN s24.MONTH_ = 4 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Apr2024,
    MAX(CASE WHEN s24.MONTH_ = 5 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS May2024,
    MAX(CASE WHEN s24.MONTH_ = 6 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Jun2024,
    MAX(CASE WHEN s24.MONTH_ = 7 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Jul2024,
    MAX(CASE WHEN s24.MONTH_ = 8 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Aug2024,
    MAX(CASE WHEN s24.MONTH_ = 9 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Sep2024,
    MAX(CASE WHEN s24.MONTH_ = 10 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Oct2024,
    MAX(CASE WHEN s24.MONTH_ = 11 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Nov2024,
    MAX(CASE WHEN s24.MONTH_ = 12 THEN dbo.safeDivide(s24.TOTAL_VATMATRAH, s24.TOTAL_AMOUNT) END) AS Dec2024,
    
    -- 2025 Çeyreklik ortalamalar
    dbo.safeDivide(
        SUM(CASE WHEN s25.MONTH_ IN (1,2,3) THEN s25.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s25.MONTH_ IN (1,2,3) THEN s25.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q1_2025,
    dbo.safeDivide(
        SUM(CASE WHEN s25.MONTH_ IN (4,5,6) THEN s25.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s25.MONTH_ IN (4,5,6) THEN s25.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q2_2025,   
    dbo.safeDivide(
        SUM(CASE WHEN s25.MONTH_ IN (7,8,9) THEN s25.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s25.MONTH_ IN (7,8,9) THEN s25.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q3_2025,
    dbo.safeDivide(
        SUM(CASE WHEN s25.MONTH_ IN (10,11,12) THEN s25.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s25.MONTH_ IN (10,11,12) THEN s25.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q4_2025,
    
    -- 2024 Çeyreklik ortalamalar
    dbo.safeDivide(
        SUM(CASE WHEN s24.MONTH_ IN (1,2,3) THEN s24.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s24.MONTH_ IN (1,2,3) THEN s24.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q1_2024,
     dbo.safeDivide(
        SUM(CASE WHEN s24.MONTH_ IN (4,5,6) THEN s24.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s24.MONTH_ IN (4,5,6) THEN s24.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q2_2024,   
    dbo.safeDivide(
        SUM(CASE WHEN s24.MONTH_ IN (7,8,9) THEN s24.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s24.MONTH_ IN (7,8,9) THEN s24.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q3_2024,
    dbo.safeDivide(
        SUM(CASE WHEN s24.MONTH_ IN (10,11,12) THEN s24.TOTAL_VATMATRAH ELSE 0 END),
        NULLIF(SUM(CASE WHEN s24.MONTH_ IN (10,11,12) THEN s24.TOTAL_AMOUNT ELSE 0 END), 0)
    ) AS Q4_2024,

    -- Yıllık ağırlıklı ortalamalar
    dbo.safeDivide(SUM(s25.TOTAL_VATMATRAH), NULLIF(SUM(s25.TOTAL_AMOUNT), 0)) AS AvgPrice2025,
    dbo.safeDivide(SUM(s24.TOTAL_VATMATRAH), NULLIF(SUM(s24.TOTAL_AMOUNT), 0)) AS AvgPrice2024,
    dbo.safeDivide(s23.TOTAL_VATMATRAH, NULLIF(s23.TOTAL_AMOUNT, 0)) AS AvgPrice2023,
    dbo.safeDivide(s22.TOTAL_VATMATRAH, NULLIF(s22.TOTAL_AMOUNT, 0)) AS AvgPrice2022,
    
    -- LastPrice (fixed column binding)
    (SELECT dbo.safeDivide(VATMATRAH, AMOUNT)
     FROM LastPriceCTE 
     WHERE CODE = i.CODE 
     AND RN = 1) AS LastPrice,

    -- LastYearlyAvgPrice (yıllık ağırlıklı ortalama)
    COALESCE(
        NULLIF(dbo.safeDivide(SUM(s25.TOTAL_VATMATRAH), SUM(s25.TOTAL_AMOUNT)), 0),
        NULLIF(dbo.safeDivide(SUM(s24.TOTAL_VATMATRAH), SUM(s24.TOTAL_AMOUNT)), 0),
        NULLIF(dbo.safeDivide(s23.TOTAL_VATMATRAH, s23.TOTAL_AMOUNT), 0),
        NULLIF(dbo.safeDivide(s22.TOTAL_VATMATRAH, s22.TOTAL_AMOUNT), 0)
    ) AS LastYearlyAvgPrice

FROM CurrentItemsCTE i
LEFT JOIN Sales2025CTE s25 ON i.CODE = s25.CODE
LEFT JOIN Sales2024CTE s24 ON i.CODE = s24.CODE
LEFT JOIN Sales2023CTE s23 ON i.CODE = s23.CODE
LEFT JOIN Sales2022CTE s22 ON i.CODE = s22.CODE
GROUP BY i.CODE, 
         i.NAME,
         i.MOULDCODE,
         i.MOULDNAME,
         s23.TOTAL_VATMATRAH, 
         s23.TOTAL_AMOUNT,
         s22.TOTAL_VATMATRAH, 
         s22.TOTAL_AMOUNT;